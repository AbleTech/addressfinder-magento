<script>
  require(['domReady!'], function(){
    console.log("file loaded");

    (function() {

      function usingKnockout(){
        return !!document.querySelector('[data-bind]');
      };

      function knockoutLoaded(){
        // TODO - this needs work (what is the knockoutIdRegex?)
        var knockoutIdRegex = new RegExp("^[A-Z0-9]{7}$");
        var allElements = document.getElementsByTagName("*");
        for (var i = 0; i < allElements.length; i++) {
          if (knockoutIdRegex.test(allElements[i].id)){
            return true;
          };
        };
        return false;
      };

      function initAF(){
        // TODO - input[name='street[0]']
        var widget = new AddressFinder.Widget(document.querySelector("input[name='street[0]']"), 'ADDRESSFINDER_AU_DEMO_KEY', 'AU', {});
      };

      function loadAF(){
        var count = document.querySelectorAll("input[name*=street]").length
        console.log(count + ' street inputs')
        if (count){
          var script = document.createElement('script');
          script.src = '//api.addressfinder.io/assets/v3/widget.js';
          script.async = true;
          script.onload = initAF;
          document.body.appendChild(script);
        };
      };

      function start(){
        if (usingKnockout()){
          // wait for Knockout to load
          if (knockoutLoaded()){
            loadAF();
          } else {
            setTimeout(start, 5000);
          };
        } else {
          loadAF();
        };
      };

      start();

    })();

  });
</script>