<script>
  // MAGENTO v2
  //   #street_1 // account
  //   name=country_id
  //   [name=street[0]] // shipping checkout
  //   [name=street[0]] // billing checkout

  /** billing & shipping
    UNDER: .billing-address-form & .form-shipping-address

    name=street[0]
    name=street[1]
    name=city
    name=region_id (state/province)
    name=postcode
    name=country_id
  **/

  window.debugAF = true;

  // TODO - only require addressfinder when needed
  require(['addressfinder', 'domReady!'], function(AddressFinder){
    if (debugAF){ console.log('required addressfinder'); };

    (function() {
      var currentUrl = location.href;
      var selectors = ["input#street_1", // address book
                       ".billing-address-form input[name='street[0]']",
                       ".form-shipping-address input[name='street[0]']"];
      var widgets = {};

      function usingKnockout(){
        return !!document.querySelector('[data-bind]');
      };

      function knockoutLoaded(){
        return !!document.querySelector('[data-bind]:last-child').innerText.trim().length;
      };

      function watchUrl(){
        if (debugAF){ console.log('watching url'); };
        if (location.href != currentUrl) {
          currentUrl = location.href;
          setTimeout(initAF, 500);
        } else {
          setTimeout(watchUrl, 1000);
        }
      };

      function disableWidgets(widgetGroup){
        if (debugAF){ console.log('disabling widgets for '+widgetGroup); };
        widgets[widgetGroup]['AU'].disable();
        widgets[widgetGroup]['NZ'].disable();
      }

      function setWidgetState(widgetGroup, countrySelect){
        disableWidgets(widgetGroup);
        var countryCode = countrySelect.value;
        if (countryCode && (countryCode == 'NZ' || countryCode == 'AU')) {
          if (debugAF){ console.log('enabling '+widgetGroup+" for "+countryCode); };
          widgets[widgetGroup][countryCode].enable();
        };
      }

      function initAF(){
        for (var e = 0; e < selectors.length; e++){
          (function(){
            var input = document.querySelector(selectors[e]);
            if (input){
              var widgetGroup = selectors[e];
              widgets[widgetGroup] = {
                'AU': new AddressFinder.Widget(input, 'ADDRESSFINDER_AU_DEMO_KEY', 'AU', {}),
                'NZ': new AddressFinder.Widget(input, 'ADDRESSFINDER_NZ_DEMO_KEY', 'NZ', {})
              };
              var countrySelect = input.form.querySelector('select[name=country_id]');
              setWidgetState(widgetGroup, countrySelect);
              countrySelect.addEventListener('change', function(){
                if (debugAF){ console.log('country changed'); };
                setWidgetState(widgetGroup, countrySelect);
              });
            };
          })();
        };

        if (debugAF){ console.log('DONE', widgets); };

        if (!!currentUrl.match(/\/checkout/i)){ watchUrl(); };
      };

      function loadAF(){
        if (debugAF){ console.log('precheck'); };
        if (document.querySelectorAll(selectors.join(', ')).length){
          // TODO - require addressfinder should go here
          if (debugAF){ console.log('addressfinder loaded', AddressFinder); };
          initAF();
        } else {
          if (debugAF){ console.log("addressfinder isn't needed on this page"); };
        };
      };

      function start(){
        if (usingKnockout() && !knockoutLoaded()){
          if (debugAF){ console.log('waiting for knockout'); };
          setTimeout(start, 2000);
        } else {
          loadAF();
        };
      };

      start();

    })();

  });
</script>